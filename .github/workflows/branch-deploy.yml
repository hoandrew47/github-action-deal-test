name: Branch Deploy

on:
  workflow_dispatch:
    inputs:
      branch-name:
        description: 'Branch to deploy'
        required: true
        type: string
      neon-username:
        description: 'Neon username'
        required: true
        type: string
        default: neondb_owner

jobs:
  setup-database:
    runs-on: ubuntu-latest
    steps:
      - name: Create Neon Database Branch
        uses: neondatabase/create-branch-action@v5
        id: create-branch
        with:
          project_id: ${{ secrets.NEON_BRANCH_PROJECT_ID }}
          branch_name: ${{ github.event.inputs.branch-name }}
          database: neondb
          username: ${{ github.event.inputs.neon-username }}
          prisma: true
          api_key: ${{ secrets.NEON_API_KEY }}
      - name: Echo Database URL
        run: echo "Database URL ${{ steps.create-branch.outputs.db_url }}"
      - name: Echo Host
        run: echo "Host ${{ steps.create-branch.outputs.host }}"
      - name: Echo Branch ID
        run: echo "Branch ID ${{ steps.create-branch.outputs.branch_id }}"

  set-up-redis:
    runs-on: ubuntu-latest
    steps:
      - name: Create a Redis DB
        id: create-redis
        uses: bitovi/github-actions-deploy-redis-db@v0.1.1
        with:
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_default_region: eu-west-2
          aws_redis_enable: true

      - name: Echo Completion
        run: echo "Redis DB creation completed successfully!"

      - name: Echo Redis Connection String Secret
        run: echo "Redis Connection String Secret ${{ steps.create-redis.outputs.redis_connection_string_secret }}"
